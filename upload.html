<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Uploaded Data - QR System</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background: #f4f6f8; text-align:center; margin:0; }
nav { cursor: default; display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background:#2c3e50; color:white; flex-wrap: wrap; }
.nav-left { cursor: default; display: flex; align-items: center; margin-bottom: 5px; }
.team-logo { cursor: default; width: 40px; height: 40px; margin-right: 10px; border-radius: 8px; }
.EDT { cursor: default; font-size: 20px; margin:0; }
.nav-right a { cursor: default; color:white; margin-left: 10px; text-decoration:none; font-weight:bold; }
.nav-right a:hover { cursor: default; text-decoration: underline; color:#ecf0f1; }

h2 { cursor: default; margin-top:20px; color:#34495e; font-size:18px; }
.search-container { margin:15px auto; }
.search-container input { padding:8px; width:90%; max-width:300px; border-radius:5px; border:1px solid #ccc; }

table { width:95%; max-width:900px; margin:15px auto; border-collapse: collapse; background:white; border-radius:10px; overflow:hidden; box-shadow:0 3px 10px rgba(0,0,0,0.1); font-size:12px; }
th, td { cursor: default; padding:10px 6px; border-bottom:1px solid #ddd; text-align:center; word-break:break-word; }
th { background:#2980b9; color:white; }
tr:hover { background:#d1e7ff; }

button { padding:5px 8px; border-radius:5px; border:none; cursor:pointer; font-weight:bold; margin:2px; font-size:12px; }
button.view-btn { background:#27ae60; color:white; }
button.delete-btn { background:#c0392b; color:white; }
button.delete-all-btn { background:#e67e22; color:white; margin-bottom:10px; }

#info-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; padding:10px; box-sizing:border-box; }
#info-modal .modal-content { background:white; padding:15px; border-radius:10px; width:95%; max-width:350px; text-align:left; }
#info-modal table { width:100%; border-collapse: collapse; margin-top:10px; font-size:12px; }
#info-modal th { background:#2980b9; color:white; padding:5px 6px; text-align:left; }
#info-modal td { padding:5px 6px; }
#info-modal tr:nth-child(even) td { background:#ecf0f1; }
#info-modal tr:nth-child(odd) td { background:#fdfdfd; }
#info-modal tr:hover td { background:#d1e7ff; }
#qr-image { display:block; margin:10px auto; max-width:100%; }
#download-qr { display:block; margin:10px auto; padding:5px 10px; border:none; border-radius:5px; background:#2980b9; color:white; cursor:pointer; font-size:12px; }

/* MOBILE RESPONSIVE TABLE */
@media screen and (max-width:600px){
  th, td { font-size:10px; padding:8px 4px; }
  .nav-right a { margin-left:8px; font-size:12px; }
  h2 { font-size:16px; }
  button { font-size:10px; padding:4px 6px; }
}
</style>
</head>
<body>

<nav>
  <div class="nav-left">
    <img src="logo.png" alt="Team Logo" class="team-logo">
    <h1 class="EDT">INFINITE INNOVATORS</h1>
  </div>
  <div class="nav-right">
    <a onclick="goTo('index.html')">Home</a>
    <a onclick="goTo('upload.html')">Uploaded Data</a>
  </div>
</nav>

<div id="upload-page">
  <h2>UPLOADED DATA</h2>
  <div class="search-container">
    <input type="text" id="search-input" placeholder="Search by ID, Vendor, Material" onkeyup="searchTable()">
  </div>
  <button class="delete-all-btn" onclick="deleteAll()">Delete All</button>
  <table id="data-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Vendor</th>
        <th>Material</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="info-modal">
  <div class="modal-content">
    <h3>QR Info</h3>
    <table id="modal-table"></table>
    <canvas id="qr-image"></canvas>
    <button id="download-qr">Download QR</button>
    <button onclick="closeModal()">Close</button>
  </div>
</div>

<script type="module">
// ===== FIREBASE SETUP =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, get, child, query, orderByChild } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCzzNaUWyBn_z7A5Rjt_ooR3yEfA44heJA",
  authDomain: "laserqr-fd4fa.firebaseapp.com",
  databaseURL: "https://laserqr-fd4fa-default-rtdb.firebaseio.com",
  projectId: "laserqr-fd4fa",
  storageBucket: "laserqr-fd4fa.appspot.com",
  messagingSenderId: "191584527271",
  appId: "1:191584527271:web:71dad945fa1b18c0024c82",
  measurementId: "G-88ZMKEZT24"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const uploadedRef = ref(db, 'uploadedData');
const deletedRef = ref(db, 'deletedData');

// ===== FETCH & DISPLAY =====
function fetchUploadedData() {
  onValue(uploadedRef, snapshot => {
    const tbody = document.querySelector('#data-table tbody');
    tbody.innerHTML = '';
    snapshot.forEach(snapItem => {
      const data = snapItem.val();
      const key = snapItem.key;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${data.ID}</td>
        <td>${data.Vendor}</td>
        <td>${data.Material}</td>
        <td>
          <button class="view-btn" onclick="viewInfo('${key}')">View</button>
          <button class="delete-btn" onclick="deleteData('${key}')">Delete</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  });
}

// ===== VIEW QR =====
window.viewInfo = function(key){
  get(child(uploadedRef, key)).then(snap=>{
    if(!snap.exists()) return;
    const data = snap.val();
    const modal = document.getElementById('info-modal');
    const table = document.getElementById('modal-table');
    const canvas = document.getElementById('qr-image');
    const downloadBtn = document.getElementById('download-qr');

    table.innerHTML = '';
    for(const k of ['ID','Vendor','Material','MFG','Warranty','SupplyDate']){
      if(data[k]===undefined) continue;
      let val = data[k];
      if(k==='Warranty') val += ' months';
      const tr = document.createElement('tr');
      tr.innerHTML = `<th>${k}</th><td>${val}</td>`;
      table.appendChild(tr);
    }

    // CLEAR previous QR before drawing new
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // GENERATE QR
    QRCode.toCanvas(canvas, JSON.stringify(data), {width:200}, function(err){
      if(err) console.error(err);
    });

    downloadBtn.onclick = function(){
      const link=document.createElement('a');
      link.href = canvas.toDataURL("image/png");
      link.download = data.ID + "_QR.png";
      link.click();
    }

    modal.style.display='flex';
  });
}

window.closeModal = function(){ document.getElementById('info-modal').style.display='none'; }

// ===== DELETE =====
window.deleteData = function(key){
  if(confirm('Are you sure to delete this record?')){
    get(child(uploadedRef,key)).then(snap=>{
      if(snap.exists()){
        push(deletedRef, snap.val());
        remove(child(uploadedRef,key));
      }
    });
  }
}

window.deleteAll = function(){
  if(confirm('Move ALL uploaded data to Deleted Data?')){
    onValue(uploadedRef, snapshot=>{
      snapshot.forEach(snapItem=>{
        push(deletedRef, snapItem.val());
        remove(child(uploadedRef,snapItem.key));
      });
    }, {onlyOnce:true});
  }
}

// ===== SEARCH =====
window.searchTable = function(){
  const input = document.getElementById('search-input').value.toUpperCase();
  const rows = document.querySelectorAll('#data-table tbody tr');
  rows.forEach(row=>{
    const cells = row.getElementsByTagName('td');
    let match=false;
    for(let i=0;i<3;i++){ if(cells[i].innerText.toUpperCase().indexOf(input)>-1) match=true; }
    row.style.display = match?'':'none';
  });
}

// ===== ADD NEW UNIQUE QR =====
window.addNewQR = async function(data){
  const q = query(uploadedRef, orderByChild('Vendor'));
  const snap = await get(q);
  let exists = false;
  snap.forEach(s=>{
    if(s.val().Vendor === data.Vendor && s.val().Material === data.Material){
      exists = true;
    }
  });
  if(exists){ alert('Duplicate entry! Not added.'); return; }

  let maxID = 0;
  snap.forEach(s=>{
    const id = parseInt(s.val().ID);
    if(id > maxID) maxID = id;
  });
  data.ID = maxID+1;
  push(uploadedRef, data);
}

// ===== NAVIGATION =====
window.goTo = function(page){ window.location.href = page; }

fetchUploadedData();
</script>
</body>
</html>
